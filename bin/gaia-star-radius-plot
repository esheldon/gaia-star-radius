#!/usr/bin/env python
import numpy as np
import fitsio
import hickory
import esutil as eu
from esutil.numpy_util import between


def main():
    order = 2
    rng = np.random.RandomState(34132)

    t = fitsio.read('gaia-star-radii.fits', lower=True)
    logr = np.log10(t['radius_pixels'])
    mag = t['phot_g_mean_mag']

    ylim = [np.log10(7), np.log10(800)]
    magmin, magmax = 5, 20

    tab = hickory.Table(
        figsize=(12, 10),
        nrows=2,
        ncols=2,
    )

    xlabel = 'GAIA G [mag]'
    plys = {}
    for iband, band in enumerate(['r', 'i', 'z']):
        print(band)

        plt = tab.axes[iband]
        plt.set(
            xlabel=xlabel,
            ylabel='log10 Mask radius %s-band [pixels]' % band,
            xlim=[magmin, magmax],
            ylim=ylim,
        )

        w, = np.where(
            (t['band'] == band) &
            between(mag, magmin, magmax) &
            between(logr, ylim[0], ylim[1])
        )
        print('found:', w.size)

        plt.hexbin(
            mag[w], logr[w],
            bins='log',
            cmap='Greens',
        )

        bs = eu.stat.Binner(mag[w], logr[w])
        bs.dohist(nbin=30, calc_stats=True)

        # print(bs['hist'])

        coeffs = np.polyfit(bs['xmean'], bs['ymean'], order)
        ply = np.poly1d(coeffs)
        print(repr(coeffs))
        print(ply)
        plt.errorbar(
            bs['xmean'], bs['ymean'], yerr=bs['yerr'], color='black', zorder=1,
        )

        xvals = np.linspace(magmin, magmax)
        plt.curve(xvals, ply(xvals), color='grey', zorder=2, linestyle='solid')

        plys[band] = ply

        if band != 'r':
            tab[0, 0].curve(xvals, ply(xvals), zorder=2, alpha=0.4)

    tab[1, 1].set(xlabel=xlabel, ylabel='poly ratio')

    rp = 10.0**(plys['r'](xvals))
    ip = 10.0**(plys['i'](xvals))
    zp = 10.0**(plys['z'](xvals))

    tab[1, 1].curve(xvals, ip/rp, label='i poly/r poly')
    tab[1, 1].curve(xvals, zp/rp, label='z poly/r poly')
    tab[1, 1].legend()

    pdfname = 'rad-vs-mag.pdf'
    print('writing:', pdfname)
    tab.savefig(pdfname)

    pngname = 'rad-vs-mag.png'
    print('writing:', pngname)
    tab.savefig(pngname, dpi=150)


if __name__ == '__main__':
    main()
